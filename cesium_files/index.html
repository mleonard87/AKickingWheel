<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>A Kicking Wheel's Amazing Landsat Imagery Viewer (data courtesy of GeoScience Australia)</title>
  <script src="../Build/Cesium/Cesium.js"></script>
  <style>
      @import url(../Build/Cesium/Widgets/widgets.css);

      #cesiumContainer {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
          margin: 0;
          overflow: hidden;
          padding: 0;
          font-family: sans-serif;
      }

      body {
          padding: 0;
          margin: 0;
          overflow: hidden;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <script>
    var viewer = new Cesium.Viewer('cesiumContainer', {
                            sceneMode : Cesium.SceneMode.SCENE2D,
                            baseLayerPicker : false,
                            homeButton : false,
                            infoBox : false,
                            navigationHelpButton : false,
                            navigationInstructionsInitiallyVisible : false,
                            sceneModePicker : false, 
                            imageryProvider : new Cesium.ArcGisMapServerImageryProvider({
                                    url : 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer'
                            }),
                        });
    var landsat_layers = new Cesium.ImageryLayerCollection();
    
    window.url_list1 = [ { url: 'landsat_images/LS5_TM_NBAR_P54_GANBAR01-002_095_082_19860817.png',
                        date_recorded: '1986-08-17',
                        bbox: [ 141.9367, -32.8835, 142.4734, -32.497 ] },
                      { url: 'landsat_images/LS5_TM_NBAR_P54_GANBAR01-002_095_083_19860817.png',
                        date_recorded: '1986-08-17',
                        bbox: [ 141.9367, -32.8835, 142.4734, -32.497 ] },
                      { url: 'landsat_images/LS5_TM_NBAR_P54_GANBAR01-002_096_082_19870523.png',
                        date_recorded: '1987-05-23',
                        bbox: [ 141.9367, -32.8835, 142.4734, -32.497 ] },
                      { url: 'landsat_images/LS5_TM_NBAR_P54_GANBAR01-002_096_083_19870523.png',
                        date_recorded: '1987-05-23',
                        bbox: [ 141.9367, -32.8835, 142.4734, -32.497 ] },
                      { url: 'landsat_images/LS5_TM_NBAR_P54_GANBAR01-002_096_082_19870912.png',
                        date_recorded: '1987-09-12',
                        bbox: [ 141.9367, -32.8835, 142.4734, -32.497 ] } ];

    function changeLandsatLayers(url_list) {
        var destroyRemovedLayers = true;
        landsat_layers.removeAll(destroyRemovedLayers);
        var min_date = Cesium.JulianDate.fromIso8601("9999-01-25"); // Some time in the distant future
        var max_date = Cesium.JulianDate.fromIso8601("1500-01-25"); // Some time before landsat

        for (var i=0; i<url_list.length; i++)
        {
            var rectangle = Cesium.Rectangle.fromDegrees(url_list[i]["bbox"][0],
                                                        url_list[i]["bbox"][1],
                                                        url_list[i]["bbox"][2],
                                                        url_list[i]["bbox"][3]);

            var landsat_layer = viewer.scene.imageryLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({
                url : url_list[i]["url"],
                rectangle : rectangle
            }));
            landsat_layer.show = true;
            landsat_layer.alpha = 0;
            url_list[i]["layer"] = landsat_layer;
            landsat_layers.add(landsat_layer);

            // Work out the date range the images cover, so that we can display only that range on the 
            // time slider.
            if (Cesium.JulianDate.lessThan(Cesium.JulianDate.fromIso8601(url_list[i]["date_recorded"]), min_date)) 
            {
                min_date = Cesium.JulianDate.fromIso8601(url_list[i]["date_recorded"]);
            }
            if (Cesium.JulianDate.greaterThan(Cesium.JulianDate.fromIso8601(url_list[i]["date_recorded"]), max_date)) 
            {
                max_date = Cesium.JulianDate.fromIso8601(url_list[i]["date_recorded"]);
            }
        }

        // Set time
        viewer.clock.startTime = min_date;
        viewer.clock.currentTime = min_date;
        viewer.clock.stopTime = max_date;
        viewer.clock.shouldAnimate = false;
        viewer.clock.multiplier = 10000000.0;
        viewer.timeline.updateFromClock();    
        viewer.timeline.zoomTo(viewer.clock.startTime, viewer.clock.stopTime);
    }

    viewer.scene.camera.moveRight(1000000);
    viewer.scene.camera.moveDown(1000000);
    viewer.scene.camera.moveForward(100000);
    viewer.scene.camera.zoomIn(100);



    changeLandsatLayers(url_list1);

    // Listen for time changes so that we can change imagery
    function timeChanged(event) {
        var now = viewer.clock.currentTime;
        for (var i=0; i<window.url_list1.length; i++)
        {
            var landsat_time = Cesium.JulianDate.fromIso8601(window.url_list1[i]["date_recorded"]);
            var eps = Math.abs(Cesium.JulianDate.getDaysDifference(landsat_time, now));
            // This governs how fast the image will fade in and out. Higher epsilon = longer fade time.
            eps_test = 300.0;
            var clamped = Cesium.Math.clamp(eps, 0.0, eps_test);
            var normed = clamped/eps_test;
            if (window.url_list1[i]["layer"])
            {
                window.url_list1[i]["layer"].alpha = 1 - normed;
            }
        }
    }

    viewer.timeline.addEventListener('settime', function(event) {
        timeChanged(event);
        });

    viewer.clock.onTick.addEventListener(function(event) {
        timeChanged(event);
        });
        
  </script>
</body>
</html>
